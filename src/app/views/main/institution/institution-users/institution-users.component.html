<o-loading [isLoading]="isLoading" />

<o-sub-header [backButtonLink]="'/i/' + this.ctx.institution?.id + '/settings'" [buttons]="headerButtons" />

<!-- General Infos -->
<div class="role-counts">
    @for(role of roles; track role) {
    <div class="role-count-chip">
        <span class="role-chip">{{ role | institutionRole }}</span>
        <p>: {{rolesCounts.get(role) || 0}}</p>
    </div>
    }
</div>

<!-- Table -->
<p-table [value]="accounts" size="small" dataKey="id" [lazy]="true" (onLazyLoad)="getAccounts($event)"
    [loading]="isLoading" [(selection)]="selectedUsers" [first]="paginationFirst" [paginator]="true" [rows]="10"
    [rowsPerPageOptions]="[5, 10, 20, 30]" [showCurrentPageReport]="true" [totalRecords]="totalRecords"
    currentPageReportTemplate="Página {currentPage} de {totalPages}" paginatorPosition="both" [tableStyle]="tableStyle">

    <ng-template #header>
        <!-- Filters -->
        <tr class="filters-row">
            <th></th>
            <th><p-columnFilter [showMenu]="false" type="text" field="idInInstitution"
                    placeholder="Filtrar identificador" /></th>
            <th><p-columnFilter [showMenu]="false" type="text" field="email" placeholder="Filtrar email" /></th>
            <th><p-columnFilter [showMenu]="false" type="text" field="name" placeholder="Filtrar nome" /></th>
            <th>
                <p-columnFilter field="role" matchMode="equals" [showMenu]="false">
                    <ng-template #filter let-filter="filterCallback">
                        <p-select [options]="roles" [(ngModel)]="rolesFilter" placeholder="Filtrar cargo"
                            [showClear]="true" (onChange)="filter($event.value)">
                            <!-- Items Pipe -->
                            <ng-template pTemplate="item" let-role>
                                {{ role | institutionRole }}
                            </ng-template>
                            <!-- Selected Item Pipe -->
                            <ng-template pTemplate="selectedItem" let-role>
                                {{ role | institutionRole }}
                            </ng-template>
                        </p-select>
                    </ng-template>
                </p-columnFilter>
            </th>
            <th></th>
            <th></th>
        </tr>

        <!-- Header -->
        <tr class="thead-row">
            <th><p-tableHeaderCheckbox /></th>
            <th style="width:20%">Identificador</th>
            <th style="width:20%">Email</th>
            <th style="width:20%">Nome</th>
            <th style="width:15%">Cargo</th>
            <th style="width:15%">Senha</th>
            <th style="width:5%">Perfil</th>
        </tr>
    </ng-template>

    <ng-template #body let-account let-editing="editing">
        <tr>
            <td><p-tableCheckbox [value]="account" /></td>

            <td [pEditableColumn]="account.idInInstitution" pEditableColumnField="idInInstitution">
                <p-cellEditor>
                    <ng-template #input>
                        <input type="text" pInputText [(ngModel)]="account.idInInstitution"
                            (change)="updateAccount(account)" (keydown.enter)="updateAccount(account)" />
                    </ng-template>
                    <ng-template #output>{{ account.idInInstitution }}</ng-template>
                </p-cellEditor>
            </td>

            <td [pEditableColumn]="account.email" pEditableColumnField="email">
                <p-cellEditor>
                    <ng-template #input>
                        <input type="email" pInputText [(ngModel)]="account.email" (change)="updateAccount(account)"
                            (keydown.enter)="updateAccount(account)" />
                    </ng-template>
                    <ng-template #output>{{ account.email }}</ng-template>
                </p-cellEditor>
            </td>

            <td>{{ account.user.name }}</td>

            <td [pEditableColumn]="account.institutionRole" pEditableColumnField="institutionRole">
                <p-cellEditor>
                    <ng-template #input>
                        <p-select [options]="roles" [(ngModel)]="account.institutionRole" [checkmark]="true"
                            (onChange)="updateAccount(account)">
                            <!-- Items Pipe -->
                            <ng-template pTemplate="item" let-role>
                                {{ role | institutionRole }}
                            </ng-template>
                            <!-- Selected Item Pipe -->
                            <ng-template pTemplate="selectedItem" let-role>
                                {{ role | institutionRole }}
                            </ng-template>
                        </p-select>
                    </ng-template>
                    <ng-template #output>
                        <span class="role-chip">{{ account.institutionRole | institutionRole }}</span>
                    </ng-template>
                </p-cellEditor>
            </td>

            <td>
                <!-- TODO: This feature is temporarily disabled. Enable it when card #24 is done -->
                <button mat-raised-button (click)="resetPassword(account)" style="height: 30px" [disabled]="true"
                    style="pointer-events: auto"
                    pTooltip="Esta funcionalidade está temporariamente desativada. Contate o administrador do sistema para redefinir a senha.">
                    Redefinir senha
                </button>
            </td>

            <td class="avatar-col">
                <o-avatar [src]="getProfilePictureUrl(account.user)" [id]="account.user.id" [size]="28" />
            </td>
        </tr>
    </ng-template>
</p-table>