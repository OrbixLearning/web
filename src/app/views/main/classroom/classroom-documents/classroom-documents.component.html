<o-loading [isLoading]="isLoading" />

<o-sub-header [backButtonLink]="'/i/' + this.ctx.institution?.id + '/c/' + this.ctx.classroom?.id"
    [buttons]="headerButtons" />

<div class="docs">
    <!-- Left: filters/syllabus -->
    <aside class="panel left">
        <header class="panel__header">
            <h3>Filtrar documentos</h3>
        </header>
        <div class="panel__body">
            @if (documents.length > 0) {
            <div class="search-row">
                <mat-form-field appearance="outline" subscriptSizing="dynamic" class="full">
                    <mat-label>Pesquisar</mat-label>
                    <input matInput [(ngModel)]="filter" />
                </mat-form-field>
            </div>

            <div class="search-row">
                <mat-form-field appearance="fill" subscriptSizing="dynamic">
                    <mat-label>Tipo do documento</mat-label>
                    <mat-select [(ngModel)]="typeFilter">
                        <mat-option [value]="null">--</mat-option>
                        @for(type of types; track type) {
                        <mat-option [value]="type">{{type | documentType}}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>
            </div>

            <o-syllabus [syllabus]="ctx.classroom?.syllabus" mode="filter" (syllabusMarked)="markSyllabus($event)"
                [presets]="ctx.classroom?.presets" />
            } @else {
            <p class="muted">Nenhum documento disponível para filtrar.</p>
            }
        </div>
    </aside>

    <!-- Right: document list -->
    <section class="panel right">
        <header class="panel__header">
            <h3>Documentos</h3>
            <span class="count">{{ filteredDocuments.length || 0 }}</span>
        </header>

        <div class="panel__body doc-list">
            @for (document of filteredDocuments; track document.id) {
            <article class="doc-card">
                <div class="doc-card__head">
                    <h4 class="doc-title" [title]="document.name">{{ document.name }}</h4>
                    <div class="right-info">
                        <span class="ext-chip" pTooltip="Tipo do documento" tooltipPosition="left">{{ document.type |
                            documentType }}</span>
                        @if (ctx.isTeacher && document.hidden) {
                        <mat-icon pTooltip="Este documento não é visível para alunos">visibility_off</mat-icon>
                        }
                        @if (document.aiStatus === documentAIUploadStatusEnum.UPLOADED) {
                        <mat-icon pTooltip="A IA da Orbix tem o conhecimento deste documento">psychology</mat-icon>
                        }
                        <span class="ext-chip" pTooltip="Extensão do documento">{{ document.extension }}</span>
                    </div>
                </div>

                <div class="doc-card__tags">
                    <o-syllabus-tags [syllabus]="document.syllabus || []" [maxTags]="3" />
                </div>

                <div class="doc-card__actions">
                    <button mat-icon-button (click)="downloadDocument(document.id, document.name)">
                        <mat-icon>download</mat-icon>
                    </button>

                    @if (ctx.isTeacher) {
                    <button mat-icon-button (click)="updateDocument(document)">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button (click)="deleteDocument(document.id)">
                        <mat-icon>delete</mat-icon>
                    </button>
                    }
                </div>

                @if (ctx.isTeacher) {
                @if (document.aiStatus === documentAIUploadStatusEnum.FAILED) {
                <div class="ai-row ai-failed">
                    <p>Ocorreu um erro ao alimentar a IA com este documento.</p>
                    <o-text-button (onclick)="recallDocumentAI(document)">Tentar novamente</o-text-button>
                </div>
                } @else if (document.aiStatus === documentAIUploadStatusEnum.UPLOADING) {
                <div class="ai-row ai-uploading">
                    <p>Adicionando documento à IA...</p>
                    <o-loading [isLoading]="true" [local]="true" size="24px" />
                </div>
                }
                }
            </article>
            } @empty {
            <p class="empty">Nenhum documento encontrado.</p>
            }
        </div>
    </section>
</div>