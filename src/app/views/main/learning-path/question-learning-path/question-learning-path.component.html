<o-loading [isLoading]="isLoading" />

@if (mode === 'study') {

<div class="study-mode">
    <!-- LEFT: current question -->
    <section class="q-left">
        <header class="q-header">
            <h3 class="q-title">Questão {{ index + 1 }} de {{ questionsContext.length }}</h3>
            <div>
                <o-text-button (onclick)="askForExplanation()">Pedir explicação</o-text-button>
                <o-text-button (onclick)="showAnswer()">{{(questionContext?.showAnswer ? "Esconder" : "Mostrar") + "
                    resposta"}}</o-text-button>
            </div>
        </header>

        <div class="q-statement">
            <p>{{ question?.statement }}</p>
        </div>

        <div class="q-choices">
            @switch (question?.type) {
            @case (questionTypeEnum.MULTIPLE_CHOICE) {
            <mat-selection-list class="choices" [multiple]="false"
                (selectionChange)="markSingle($event.options[0].value)">
                @for (option of question?.options; track option) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="radio">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.MULTIPLE_SELECTION) {
            <mat-selection-list class="choices" [multiple]="true"
                (selectionChange)="markMulti($event.options[0].value)">
                @for (option of question?.options; track option) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="checkbox">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.TRUE_FALSE) {
            <mat-button-toggle-group class="tf-group" (valueChange)="markSingle($event)">
                <mat-button-toggle [checked]="userAnswer.includes('true')" value="true">Verdadeiro</mat-button-toggle>
                <mat-button-toggle [checked]="userAnswer.includes('false')" value="false">Falso</mat-button-toggle>
            </mat-button-toggle-group>
            }

            @case (questionTypeEnum.OPEN_ENDED) {
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="open-ended">
                <mat-label>Resposta</mat-label>
                <textarea matInput rows="6" [value]="userAnswer[0] || ''" (input)="updateOpenEndedAnswer($event)"
                    cdkTextareaAutosize></textarea>
            </mat-form-field>
            }
            }
        </div>

        @if (questionContext?.showAnswer) {
        <div class="q-correct">
            <span class="label">Resposta correta:</span>
            <span class="value">{{ currentQuestionAnswerFormatted }}</span>
        </div>
        }

        <div class="q-nav">
            @if (index > 0) {
            <o-text-button (onclick)="previousQuestion()">Anterior</o-text-button>
            }
            @if (index < (questionsContext.length - 1)) { <o-text-button (onclick)="nextQuestion()">
                Próxima</o-text-button>
                }
        </div>
    </section>

    <!-- RIGHT: list + actions -->
    <aside class="q-right">
        <div class="questions-menu" role="list">
            @for (context of questionsContext; track $index; let i = $index) {
            <button mat-stroked-button class="q-item" (click)="goToQuestion(i)"
                [class.answered]="context.userAnswer.length > 0"
                [class.incorrect]="context.showAnswer && !verifyUserAnswer(i)">
                <mat-icon>{{ context.userAnswer.length > 0 ? 'check' : 'close' }}</mat-icon>
                <span>Questão {{ i + 1 }} {{ context.userAnswer.length > 0 ? '' : '(não respondida)' }}</span>
            </button>
            }
        </div>

        <div class="q-actions">
            @if (!allAnswersShowed) {
            <o-highlight-button (onclick)="showAnswers()">Verificar todas as respostas</o-highlight-button>
            } @else {
            <p class="q-summary">{{ amountOfIncorrectAnswers }} respostas incorretas</p>
            <o-text-button (onclick)="hideAllAnswers()">Esconder todas as respostas</o-text-button>
            }
            @if (hasAnyAnswer) {
            <o-text-button icon="clear_all" (onclick)="clearAnswers()">
                Limpar Respostas
            </o-text-button>
            }
        </div>
    </aside>
</div>

} @else {

<section class="edit-mode">
    <header class="vm-header">
        <o-highlight-button icon="add" matButton [matMenuTriggerFor]="menu">Criar questão</o-highlight-button>
        <mat-menu #menu="matMenu">
            @for (type of QUESTION_TYPES; track type) {
            <button mat-menu-item (click)="addQuestion(type)">{{ type | questionType }}</button>
            }
        </mat-menu>
        @if (ctx.isTeacher) {
        <o-highlight-button icon="save_alt" (onclick)="importQuestion()">Importar questão</o-highlight-button>
        }
    </header>

    <div class="vm-list" role="list">
        @for (question of questions; track $index; let i = $index) {
        <o-question-card [index]="i" [question]="question" [showSelect]="false" [showExport]="ctx.isTeacher"
            (edit)="editQuestion(i)" (remove)="deleteQuestion(i)" (export)="exportQuestion(i)" />
        }
    </div>
</section>

}