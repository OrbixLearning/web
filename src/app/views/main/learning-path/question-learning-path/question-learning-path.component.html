<div class="question">

    @if (mode === 'study') {
    <!-- LEFT: current question -->
    <section class="q-left">
        <header class="q-header">
            <h3 class="q-title">Questão {{ index + 1 }} de {{ questionsContext.length }}</h3>
        </header>

        <div class="q-statement">
            <p>{{ question?.statement }}</p>
        </div>

        <div class="q-choices">
            @switch (question?.type) {
            @case (questionTypeEnum.MULTIPLE_CHOICE) {
            <mat-selection-list class="choices" [multiple]="false"
                (selectionChange)="markSingle($event.options[0].value)">
                @for (option of question?.options; track $index) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="radio">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.MULTIPLE_SELECTION) {
            <mat-selection-list class="choices" [multiple]="true"
                (selectionChange)="markMulti($event.options[0].value)">
                @for (option of question?.options; track $index) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="checkbox">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.TRUE_FALSE) {
            <mat-button-toggle-group class="tf-group" (valueChange)="markSingle($event)">
                <mat-button-toggle [checked]="userAnswer.includes('true')" value="true">
                    Verdadeiro
                </mat-button-toggle>
                <mat-button-toggle [checked]="userAnswer.includes('false')" value="false">
                    Falso
                </mat-button-toggle>
            </mat-button-toggle-group>
            }

            @case (questionTypeEnum.OPEN_ENDED) {
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="open-ended">
                <mat-label>Resposta</mat-label>
                <textarea matInput rows="6" [value]="userAnswer[0] || ''" (input)="updateOpenEndedAnswer($event)">
            </textarea>
            </mat-form-field>
            }
            }
        </div>

        @if (showAnswers) {
        <div class="q-correct">
            <span class="label">Resposta correta:</span>
            <span class="value">{{ currentQuestionAnswer }}</span>
        </div>
        }

        <div class="q-nav">
            @if (index > 0) {
            <o-text-button (onclick)="previousQuestion()">Anterior</o-text-button>
            }
            @if (index < (questionsContext.length - 1)) { <o-text-button (onclick)="nextQuestion()">
                Próxima</o-text-button>
                }
        </div>
    </section>

    <!-- RIGHT: list + actions -->
    <aside class="q-right">
        <div class="questions-menu">
            @for (context of questionsContext; track $index; let i = $index) {
            <button mat-stroked-button class="q-item" (click)="goToQuestion(i)"
                [class.answered]="context.userAnswer.length > 0"
                [class.incorrect]="showAnswers && !verifyUserAnswer(i)">
                <mat-icon>{{ context.userAnswer.length > 0 ? 'check' : 'close' }}</mat-icon>
                <span>Questão {{ i + 1 }} {{ context.userAnswer.length > 0 ? '' : '(não respondida)' }}</span>
            </button>
            }
        </div>

        <div class="q-actions">
            @if (!showAnswers) {
            <o-highlight-button (onclick)="verifyAnswers()">Verificar Respostas</o-highlight-button>
            } @else {
            <p class="q-summary">{{ amountOfIncorrectAnswers }} respostas incorretas</p>
            <o-text-button (onclick)="showAnswers = false">Esconder Respostas</o-text-button>
            }
        </div>
    </aside>

    } @else {
    <section class="view-mode">
        <header class="vm-header">
            <o-highlight-button icon="add">Nova questão</o-highlight-button>
        </header>

        <div class="vm-list" role="list">
            @for (ctxItem of questionsContext; track $index; let i = $index) {
            <article class="q-card" role="listitem">
                <header class="qc-head">
                    <div class="qc-left">
                        <span class="idx">Questão {{ i + 1 }}</span>
                        <span class="type">{{ ctxItem.question.type }}</span>
                    </div>
                    <div class="qc-right">
                        <o-text-button>Editar</o-text-button>
                        <o-text-button>Remover</o-text-button>
                    </div>
                </header>

                <section class="qc-body">
                    <div class="statement">
                        <p>{{ ctxItem.question.statement }}</p>
                    </div>

                    @switch (ctxItem.question.type) {
                    @case (questionTypeEnum.MULTIPLE_CHOICE) {
                    <ul class="options">
                        @for (opt of ctxItem.question.options; track opt) {
                        <li class="option" [class.is-correct]="verifyAnswer(ctxItem.question, [opt])">
                            <span class="bullet"></span>
                            <span class="text">{{ opt }}</span>
                        </li>
                        }
                    </ul>
                    }

                    @case (questionTypeEnum.MULTIPLE_SELECTION) {
                    <ul class="options">
                        @for (opt of ctxItem.question.options; track opt) {
                        <li class="option" [class.is-correct]="ctxItem.question.answers.includes(opt)">
                            <span class="check"></span>
                            <span class="text">{{ opt }}</span>
                        </li>
                        }
                    </ul>
                    }

                    @case (questionTypeEnum.TRUE_FALSE) {
                    <div class="tf">
                        <span class="chip"
                            [class.is-correct]="verifyAnswer(ctxItem.question, ['true'])">Verdadeiro</span>
                        <span class="chip" [class.is-correct]="verifyAnswer(ctxItem.question, ['false'])">Falso</span>
                    </div>
                    }

                    @case (questionTypeEnum.OPEN_ENDED) {
                    <mat-form-field appearance="outline" subscriptSizing="dynamic" class="open-ended">
                        <mat-label>Resposta correta</mat-label>
                        <textarea matInput rows="6" [value]="ctxItem.question.answers[0]"
                            [disabled]="true">        </textarea>
                    </mat-form-field>
                    }
                    }
                </section>

            </article>
            }
        </div>
    </section>
    }
</div>