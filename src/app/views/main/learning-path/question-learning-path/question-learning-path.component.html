<o-loading [isLoading]="isLoading" />

@if (mode === 'study') {

<div class="study-mode">
    <!-- LEFT: current question -->
    <section class="q-left">
        <header class="q-header">
            <h3 class="q-title">Questão {{ index + 1 }} de {{ questionsContext.length }}</h3>
        </header>

        <div class="q-statement">
            <p>{{ question?.statement }}</p>
        </div>

        <div class="q-choices">
            @switch (question?.type) {
            @case (questionTypeEnum.MULTIPLE_CHOICE) {
            <mat-selection-list class="choices" [multiple]="false"
                (selectionChange)="markSingle($event.options[0].value)">
                @for (option of question?.options; track $index) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="radio">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.MULTIPLE_SELECTION) {
            <mat-selection-list class="choices" [multiple]="true"
                (selectionChange)="markMulti($event.options[0].value)">
                @for (option of question?.options; track $index) {
                <mat-list-option class="choice-item" [selected]="userAnswer.includes(option)" [value]="option"
                    role="checkbox">
                    {{ option }}
                </mat-list-option>
                }
            </mat-selection-list>
            }

            @case (questionTypeEnum.TRUE_FALSE) {
            <mat-button-toggle-group class="tf-group" (valueChange)="markSingle($event)">
                <mat-button-toggle [checked]="userAnswer.includes('true')" value="true">Verdadeiro</mat-button-toggle>
                <mat-button-toggle [checked]="userAnswer.includes('false')" value="false">Falso</mat-button-toggle>
            </mat-button-toggle-group>
            }

            @case (questionTypeEnum.OPEN_ENDED) {
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="open-ended">
                <mat-label>Resposta</mat-label>
                <textarea matInput rows="6" [value]="userAnswer[0] || ''" (input)="updateOpenEndedAnswer($event)"
                    cdkTextareaAutosize></textarea>
            </mat-form-field>
            }
            }
        </div>

        @if (showAnswers) {
        <div class="q-correct">
            <span class="label">Resposta correta:</span>
            <span class="value">{{ currentQuestionAnswerFormatted }}</span>
        </div>
        }

        <div class="q-nav">
            @if (index > 0) {
            <o-text-button (onclick)="previousQuestion()">Anterior</o-text-button>
            }
            @if (index < (questionsContext.length - 1)) { <o-text-button (onclick)="nextQuestion()">
                Próxima</o-text-button>
                }
        </div>
    </section>

    <!-- RIGHT: list + actions -->
    <aside class="q-right">
        <div class="questions-menu" role="list">
            @for (context of questionsContext; track $index; let i = $index) {
            <button mat-stroked-button class="q-item" (click)="goToQuestion(i)"
                [class.answered]="context.userAnswer.length > 0" [class.incorrect]="showAnswers && !verifyUserAnswer(i)"
                role="listitem">
                <mat-icon>{{ context.userAnswer.length > 0 ? 'check' : 'close' }}</mat-icon>
                <span>Questão {{ i + 1 }} {{ context.userAnswer.length > 0 ? '' : '(não respondida)' }}</span>
            </button>
            }
        </div>

        <div class="q-actions">
            @if (!showAnswers) {
            <o-highlight-button (onclick)="verifyAnswers()">Verificar Respostas</o-highlight-button>
            } @else {
            <p class="q-summary">{{ amountOfIncorrectAnswers }} respostas incorretas</p>
            <o-text-button (onclick)="showAnswers = false">Esconder Respostas</o-text-button>
            }
            @if (hasAnyAnswer) {
            <o-text-button icon="clear_all" (onclick)="clearAnswers()">
                Limpar Respostas
            </o-text-button>
            }
        </div>
    </aside>
</div>

} @else {

<section class="edit-mode">
    <header class="vm-header">
        <o-highlight-button icon="add" matButton [matMenuTriggerFor]="menu">Adicionar questão</o-highlight-button>
        <mat-menu #menu="matMenu">
            @for (type of QUESTION_TYPES; track type) {
            <button mat-menu-item (click)="addQuestion(type)">{{ type | questionType }}</button>
            }
        </mat-menu>
    </header>

    <div class="vm-list" role="list">
        @for (question of questions; track $index; let i = $index) {
        <article class="q-card" role="listitem">
            <header class="qc-head">
                <div class="qc-left">
                    <span class="idx">Questão {{ i + 1 }}</span>
                    <span class="type">{{ question.type | questionType }}</span>
                </div>
                <div class="qc-right">
                    <o-text-button (onclick)="editQuestion(i)">Editar</o-text-button>
                    <o-text-button (onclick)="deleteQuestion(i)">Remover</o-text-button>
                </div>
            </header>

            <section class="qc-body">
                <div class="statement">
                    <p>{{ question.statement }}</p>
                </div>

                @switch (question.type) {
                @case (questionTypeEnum.MULTIPLE_CHOICE) {
                <ul class="options">
                    @for (opt of question.options; track opt) {
                    <li class="option" [class.is-correct]="verifyAnswer(question, [opt])">
                        <span class="bullet"></span>
                        <span class="text">{{ opt }}</span>
                    </li>
                    }
                </ul>
                }

                @case (questionTypeEnum.MULTIPLE_SELECTION) {
                <ul class="options">
                    @for (opt of question.options; track opt) {
                    <li class="option" [class.is-correct]="question.answers.includes(opt)">
                        <span class="check"></span>
                        <span class="text">{{ opt }}</span>
                    </li>
                    }
                </ul>
                }

                @case (questionTypeEnum.TRUE_FALSE) {
                <div class="tf">
                    <span class="chip" [class.is-correct]="verifyAnswer(question, ['true'])">Verdadeiro</span>
                    <span class="chip" [class.is-correct]="verifyAnswer(question, ['false'])">Falso</span>
                </div>
                }

                @case (questionTypeEnum.OPEN_ENDED) {
                <mat-form-field appearance="outline" subscriptSizing="dynamic" class="open-ended">
                    <mat-label>Resposta correta</mat-label>
                    <textarea matInput rows="6" [value]="question.answers[0]" [disabled]="true"
                        cdkTextareaAutosize></textarea>
                </mat-form-field>
                }
                }
            </section>

        </article>
        }
    </div>
</section>

}