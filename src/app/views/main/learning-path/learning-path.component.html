<o-loading [isLoading]="isLoading" />

<header class="learning-path-header">
    <button mat-icon-button (click)="goBackOrCancel()">
        <mat-icon>arrow_back</mat-icon>
    </button>

    <div>
        <mat-icon [style]="ctx.learningPathStudy?.learningPath?.validated ? '' : 'visibility: hidden'"
            pTooltip="Rota validada pelo professor">check</mat-icon>

        @if (ctx.isTeacher) {
        <o-text-button (onclick)="validateLearningPath(!ctx.learningPathStudy?.learningPath?.validated)">
            {{ctx.learningPathStudy?.learningPath?.validated ? "Invalidar rota" : "Validar rota"}}
        </o-text-button>
        }

        @if (!ctx.isTeacher && !ctx.learningPathStudy?.learningPath?.validated) {
        <o-text-button (onclick)="requestLearningPathValidation()" [disabled]="validationRequested">
            {{validationRequested ? 'Solicitação enviada' : 'Solicitar validação da rota'}}
        </o-text-button>
        }
    </div>

    @if (mine || ctx.isTeacher) {
    <o-highlight-button (onclick)="toggleMode()" [icon]="mode === 'edit' ? 'save' : 'edit'">
        {{mode === 'edit' ? 'Salvar alterações' : 'Editar rota'}}
    </o-highlight-button>
    }

    <div class="sharing-div">
        @if (mine && !ctx.learningPathStudy?.learningPath?.shared) {
        <button mat-icon-button (click)="shareLearningPath()" pTooltip="Compartilhar" tooltipPosition="top">
            <mat-icon>share</mat-icon>
        </button>
        }

        @if (ctx.learningPathStudy?.learningPath?.shared) {
        <button mat-icon-button (click)="copyLearningPathLink()" pTooltip="Copiar link para rota" tooltipPosition="top">
            <mat-icon>link</mat-icon>
        </button>

        <p-toast />
        }
    </div>

    <div>
        <button mat-icon-button (click)="infoPO.toggle($event)">
            <mat-icon>info</mat-icon>
        </button>
        <p-popover #infoPO>
            <div class="info-pop">
                <header class="ip-head">
                    <h3 class="ip-title">{{ ctx.learningPathStudy?.learningPath?.name }}</h3>

                    <div class="ip-creator">
                        <o-avatar [id]="ctx.learningPathStudy?.learningPath?.creator?.id!"
                            [src]="creatorProfilePictureUrl" />
                        <span class="ip-creator-text">
                            <strong>{{ ctx.learningPathStudy?.learningPath?.creator?.name }}</strong>
                        </span>
                    </div>
                </header>

                <section class="ip-body">
                    <p class="ip-subtitle">Tópicos contemplados</p>
                    <o-syllabus-tags class="ip-tags" [syllabus]="ctx.learningPathStudy?.learningPath?.syllabus || []" />
                </section>
            </div>
        </p-popover>


    </div>

    @if (mine && !ctx.learningPathStudy?.learningPath?.shared) {
    <button mat-icon-button (click)="deleteLearningPath()">
        <mat-icon>delete</mat-icon>
    </button>
    }
</header>

<div class="learning-path-content">
    @if (generationStatus === generationStatusEnum.GENERATING) {

    <p>A rota de aprendizagem está sendo gerada</p>

    } @else if (generationStatus === generationStatusEnum.GENERATED) {

    <div class="left" [style]="mode === 'study' ? 'width: 60%' : 'width: 100%'">
        @switch (ctx.learningPathStudy!.learningPath!.type) {
        @case (typeEnum.TEXT) {
        <o-text-learning-path #text [mode]="mode" />
        }
        @case (typeEnum.VIDEO) {
        <o-video-learning-path #video [mode]="mode" />
        }
        @case (typeEnum.FLASHCARD) {
        <o-flash-card-learning-path #flashcard [mode]="mode" />
        }
        @case (typeEnum.QUESTION) {
        <o-question-learning-path #question [mode]="mode" (askExplanation)="askForExplanation($event)" />
        }
        }
    </div>

    @if (mode === 'study') {
    <div class="right">
        <o-chat #chat [learningPaths]="[ctx.learningPathStudy!.learningPath]" [showLearningPaths]="false" height="68vh"
            [clearButton]="false" message="Esse chat já tem todo o conhecimento dessa Rota de Aprendizagem." />
    </div>
    }

    } @else if(generationStatus === generationStatusEnum.FAILED) {

    <p>Ocorreu um erro na geração da rota de aprendizagem</p>

    }
</div>